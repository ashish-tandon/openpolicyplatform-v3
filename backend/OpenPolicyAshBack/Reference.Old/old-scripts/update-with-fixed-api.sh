#!/bin/bash

echo "ğŸ”§ Updating QNAP with Fixed API Image"
echo "===================================="
echo ""

echo "ğŸ“‹ Issue Identified and Fixed:"
echo "=============================="
echo "âŒ GraphQL schema error in API container"
echo "âœ… Fixed missing @strawberry.type decorators"
echo "âœ… Fixed missing @strawberry.input decorators"
echo "âœ… New Docker image built and pushed"
echo ""

echo "ğŸš€ Updating QNAP Server:"
echo "========================"
echo ""

echo "1. ğŸ“± Open Container Station:"
echo "   http://192.168.2.152:8080"
echo ""

echo "2. ğŸ” Find your OpenPolicy application"
echo "   - Look for the docker-compose application"
echo ""

echo "3. â¹ï¸ Stop the Application:"
echo "   - Click on the application"
echo "   - Click 'Stop' or 'Stop All'"
echo "   - Wait for all containers to stop"
echo ""

echo "4. ğŸ”„ Update the API Container:"
echo "   - Find the 'openpolicy_api' container"
echo "   - Click on it"
echo "   - Click 'Update' or 'Recreate'"
echo "   - This will pull the latest fixed image"
echo ""

echo "5. â–¶ï¸ Start the Application:"
echo "   - Click 'Start' or 'Start All'"
echo "   - Wait 2-3 minutes for startup"
echo ""

echo "6. âœ… Verify API is Working:"
echo "   - Check that 'openpolicy_api' is running"
echo "   - Test: http://192.168.2.152:8000/health"
echo ""

echo "â±ï¸ Expected Timeline:"
echo "===================="
echo "â€¢ Stop application: 1-2 minutes"
echo "â€¢ Update API container: 1-2 minutes"
echo "â€¢ Start application: 2-3 minutes"
echo "â€¢ API startup: 1-2 minutes"
echo "â€¢ Total time: 5-9 minutes"
echo ""

echo "ğŸ§ª Test After Update:"
echo "===================="
echo "1. Test API Health:"
echo "   curl http://192.168.2.152:8000/health"
echo ""
echo "2. Test API Docs:"
echo "   http://192.168.2.152:8000/docs"
echo ""
echo "3. Test Dashboard:"
echo "   http://192.168.2.152:3000"
echo ""
echo "4. Run Full Validation:"
echo "   ./final-validation.sh"
echo ""

echo "ğŸ¯ Success Indicators:"
echo "====================="
echo "âœ… API responds at http://192.168.2.152:8000/health"
echo "âœ… All containers in 'Running' status"
echo "âœ… Dashboard loads real data"
echo "âœ… Flower monitor shows active tasks"
echo ""

echo "ğŸ“Š After API is Working:"
echo "======================="
echo "â€¢ First data scraping: 15-30 minutes"
echo "â€¢ Complete collection: 2-4 hours"
echo "â€¢ Real-time updates: Continuous"
echo ""

echo "ğŸš€ Ready to update!"
echo "The GraphQL schema error has been fixed in the new image." 